import React, { useState, useEffect, useRef } from 'react'; // üü¢ useRef Ï∂îÍ∞Ä
import { useParams, useNavigate } from 'react-router-dom';
import { useAuth } from 'react-oidc-context';
import FullCalendar from '@fullcalendar/react';
import dayGridPlugin from '@fullcalendar/daygrid';
import timeGridPlugin from '@fullcalendar/timegrid';
import interactionPlugin from '@fullcalendar/interaction';
import '../../styles/meetingschedule.css';
import { fetchMeetings, createMeeting, updateMeeting, deleteMeeting } from '../../services/apiService';
function MeetingManager() {
  const { view } = useParams();
  const navigate = useNavigate();
  const calendarRef = useRef(null);
  const auth = useAuth(); // react-oidc-contextÏóêÏÑú Ïù∏Ï¶ù Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
  const [isLoading, setIsLoading] = useState(false);

  const [currentDate, setCurrentDate] = useState(new Date());
  const [selectedMeeting, setSelectedMeeting] = useState(null);
  const [showCreateDialog, setShowCreateDialog] = useState(false);
  const [showEditDialog, setShowEditDialog] = useState(false);
  const [createDate, setCreateDate] = useState(null);
  const [calendarView, setCalendarView] = useState('dayGridMonth');
  const [events, setEvents] = useState([
    {
      id: 1,
      title: 'Project Update',
      start: '2025-05-08T09:00:00',
      end: '2025-05-08T10:00:00',
      backgroundColor: '#bfdbfe',
      borderColor: '#3b82f6',
      extendedProps: {
        participants: ['ÍπÄÏú†Î¶¨', 'Î∞ïÏßÄÏó∞', 'Ïù¥ÎØºÌò∏'],
        desc: 'ÌîÑÎ°úÏ†ùÌä∏ ÌòÑÌô© Í≥µÏú† Î∞è Ïù¥Ïäà ÎÖºÏùò'
      }
    },
    {
      id: 2,
      title: 'Team Sync',
      start: '2025-05-08T11:00:00',
      end: '2025-05-08T12:00:00',
      backgroundColor: '#fed7aa',
      borderColor: '#f97316',
      extendedProps: {
        participants: ['ÍπÄÏú†Î¶¨', 'Î∞ïÏßÄÏó∞'],
        desc: 'ÌåÄ ÏóÖÎ¨¥ ÎèôÍ∏∞Ìôî'
      }
    },
    {
      id: 3,
      title: 'Client Meeting',
      start: '2025-05-08T15:00:00',
      end: '2025-05-08T16:30:00',
      backgroundColor: '#fecaca',
      borderColor: '#ef4444',
      extendedProps: {
        participants: ['ÍπÄÏú†Î¶¨', 'Î∞ïÏßÄÏó∞', 'Ïù¥ÎØºÌò∏', 'Ï†ïÏàòÏßÑ'],
        desc: 'Í≥†Í∞ùÏÇ¨ ÎØ∏ÌåÖ Î∞è ÏöîÍµ¨ÏÇ¨Ìï≠ Ï†ïÎ¶¨'
      }
    }
  ]);

  // üü¢ FullCalendar Î∑∞ Î≥ÄÍ≤ΩÏùÑ ÏúÑÌïú Ìï®Ïàò ÏàòÏ†ï
  const changeView = (newView) => {
    navigate(`/meeting-manager/${newView}`);

    const viewMap = {
      month: 'dayGridMonth',
      week: 'timeGridWeek',
      day: 'timeGridDay'
    };

    const mappedView = viewMap[newView] || 'dayGridMonth';
    setCalendarView(mappedView);

    const calendarApi = calendarRef.current?.getApi();
    if (calendarApi) {
      calendarApi.changeView(mappedView);
    }
  };

// ÎØ∏ÌåÖ Î™©Î°ù Í∞ÄÏ†∏Ïò§Í∏∞
useEffect(() => {
  const loadMeetings = async () => {
    try {
      setIsLoading(true);
      
      // Ïù∏Ï¶ù ÏÉÅÌÉú ÌôïÏù∏
      if (!auth.isAuthenticated || !auth.user) {
        console.log('ÏÇ¨Ïö©ÏûêÍ∞Ä Ïù∏Ï¶ùÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§. Í∏∞Î≥∏ Îç∞Ïù¥ÌÑ∞Î•º ÏÇ¨Ïö©Ìï©ÎãàÎã§.');
        return; // Í∏∞Î≥∏ ÎçîÎØ∏ Îç∞Ïù¥ÌÑ∞ Ïú†ÏßÄ
      }
      
      // id_token ÎòêÎäî access_token Í∞ÄÏ†∏Ïò§Í∏∞
      const token = auth.user?.id_token || auth.user?.access_token;
      console.log('ÌÜ†ÌÅ∞ ÌÉÄÏûÖ:', auth.user?.id_token ? 'id_token' : 'access_token');
      console.log('ÌÜ†ÌÅ∞ Ï≤´ 30Ïûê:', token?.substring(0, 30));

      // API Ìò∏Ï∂úÌïòÏó¨ ÎØ∏ÌåÖ Î™©Î°ù Í∞ÄÏ†∏Ïò§Í∏∞
      const data = await fetchMeetings(token);
      
      // ÏùëÎãµ Îç∞Ïù¥ÌÑ∞ Ï≤òÎ¶¨
      if (data && data.meetings) {
        console.log('ÎØ∏ÌåÖ Îç∞Ïù¥ÌÑ∞ ÏàòÏã†:', data.meetings.length + 'Í∞ú Ìï≠Î™©');
        
        // FullCalendar ÌòïÏãùÏúºÎ°ú Îç∞Ïù¥ÌÑ∞ Î≥ÄÌôò
        const formattedEvents = data.meetings.map(meeting => ({
          id: meeting.meetingId,
          title: meeting.title,
          start: meeting.start,
          end: meeting.end,
          backgroundColor: meeting.color?.backgroundColor || eventColors.default.backgroundColor,
          borderColor: meeting.color?.borderColor || eventColors.default.borderColor,
          extendedProps: {
            participants: meeting.participants,
            desc: meeting.description || ''
          }
        }));
        
        setEvents(formattedEvents);
      }
    } catch (error) {
      console.error('ÎØ∏ÌåÖ Î™©Î°ù Î°úÎî© Ïò§Î•ò:', error);
      // Ïò§Î•ò Î∞úÏÉù Ïãú ÏÇ¨Ïö©ÏûêÏóêÍ≤å ÏïåÎ¶º (ÏÑ†ÌÉù ÏÇ¨Ìï≠)
      // alert('ÎØ∏ÌåÖ Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message);
    } finally {
      setIsLoading(false);
    }
  };

  loadMeetings();
}, [auth.isAuthenticated, auth.user]);

  const handleDateClick = (arg) => {
    setCreateDate(arg.date);
    setShowCreateDialog(true);
  };

  const handleEventClick = (arg) => {
    const event = {
      id: arg.event.id,
      title: arg.event.title,
      start: new Date(arg.event.start),
      end: new Date(arg.event.end),
      time: `${new Date(arg.event.start).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })} - ${new Date(arg.event.end).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`,
      participants: arg.event.extendedProps.participants,
      desc: arg.event.extendedProps.desc,
      backgroundColor: arg.event.backgroundColor,
      borderColor: arg.event.borderColor
    };
    setSelectedMeeting(event);
  };

   // Í∏∞Ï°¥ Ìï®Ïàò ÏàòÏ†ï: handleCreateMeeting
   const handleCreateMeeting = async (meetingData) => {
    if (!auth.isAuthenticated) {
      alert('Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.');
      return;
    }
    
    try {
      setIsLoading(true);
      const token = auth.user?.id_token || auth.user?.access_token;
      
      const result = await createMeeting(token, {
        title: meetingData.title,
        start: meetingData.start.toISOString(),
        end: meetingData.end.toISOString(),
        participants: meetingData.participants,
        description: meetingData.desc
      });
      console.log('ÎØ∏ÌåÖ ÏÉùÏÑ± ÏÑ±Í≥µ:', result);
      // ÏÑ±Í≥µ Ïãú Î°úÏª¨ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
      const newEvent = {
        id: result.meetingId,
        title: meetingData.title,
        start: meetingData.start.toISOString(),
        end: meetingData.end.toISOString(),
        ...eventColors.default,
        extendedProps: {
          participants: meetingData.participants,
          desc: meetingData.desc
        }
      };
      
      setEvents(prevEvents => [...prevEvents, newEvent]);
      setShowCreateDialog(false);
      
      alert('ÎØ∏ÌåÖÏù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§.');
    } catch (error) {
      console.error('ÎØ∏ÌåÖ ÏÉùÏÑ± Ïò§Î•ò:', error);
      alert(`ÎØ∏ÌåÖ ÏÉùÏÑ± Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ${error.message}`);
    } finally {
      setIsLoading(false);
    }
  };
  

  const handleEditMeeting = async (meetingData) => {
    if (!auth.isAuthenticated) {
      alert('Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.');
      return;
    }
    
    try {
      setIsLoading(true);
      const token = auth.user.access_token;
      
      await updateMeeting(token, meetingData.id, {
        title: meetingData.title,
        start: meetingData.start.toISOString(),
        end: meetingData.end.toISOString(),
        participants: meetingData.participants,
        description: meetingData.desc
      });
      
      // Î°úÏª¨ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
      const updatedEvents = events.map(event => 
        event.id === meetingData.id ? {
          ...event,
          title: meetingData.title,
          start: meetingData.start.toISOString(),
          end: meetingData.end.toISOString(),
          extendedProps: {
            participants: meetingData.participants,
            desc: meetingData.desc
          }
        } : event
      );
      
      setEvents(updatedEvents);
      setSelectedMeeting(null);
      setShowEditDialog(false);
    } catch (error) {
      console.error('ÎØ∏ÌåÖ ÏàòÏ†ï Ïò§Î•ò:', error);
      alert(`ÎØ∏ÌåÖ ÏàòÏ†ï Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ${error.message}`);
    } finally {
      setIsLoading(false);
    }
  };

  const handleDeleteMeeting = async (id) => {
    if (!auth.isAuthenticated) {
      alert('Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.');
      return;
    }
    
    if (window.confirm('Ï†ïÎßêÎ°ú Ïù¥ ÏùºÏ†ïÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
      try {
        setIsLoading(true);
        const token = auth.user.access_token;
        
        await deleteMeeting(token, id);
        
        // Î°úÏª¨ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
        setEvents(events.filter(event => event.id !== id));
        setSelectedMeeting(null);
      } catch (error) {
        console.error('ÎØ∏ÌåÖ ÏÇ≠Ï†ú Ïò§Î•ò:', error);
        alert(`ÎØ∏ÌåÖ ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ${error.message}`);
      } finally {
        setIsLoading(false);
      }
    }
  };

  // Î™®Îã¨: ÏùºÏ†ï ÏÉÅÏÑ∏
  const MeetingDetailModal = ({ meeting, onClose }) => (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal-detail modern-modal" onClick={e => e.stopPropagation()}>
        <div className="modal-header">
          <h4 className="modal-title">{meeting.title}</h4>
          <button className="modal-close-icon" onClick={onClose}>√ó</button>
        </div>
        <div className="modal-content">
          <div className="modal-info-group">
            <div className="modal-info-label">ÏãúÍ∞Ñ</div>
            <div className="modal-info-value">{meeting.time}</div>
          </div>
          <div className="modal-info-group">
            <div className="modal-info-label">ÏÑ§Î™Ö</div>
            <div className="modal-info-value modal-desc">{meeting.desc}</div>
          </div>
          <div className="modal-info-group">
            <div className="modal-info-label">Ï∞∏ÏÑùÏûê</div>
            <div className="modal-participants">
              {meeting.participants.map((p, i) => (
                <span key={i} className="modal-participant">{p}</span>
              ))}
            </div>
          </div>
        </div>
        <div className="modal-actions">
          <button className="modal-edit-btn modern-button" onClick={() => {
            setShowEditDialog(true);
            onClose();
          }}>ÏàòÏ†ïÌïòÍ∏∞</button>
          <button className="modal-delete-btn modern-button-secondary" onClick={() => handleDeleteMeeting(meeting.id)}>ÏÇ≠Ï†ú</button>
        </div>
      </div>
    </div>
  );

  // Î™®Îã¨: ÏùºÏ†ï ÏÉùÏÑ±/ÏàòÏ†ï
  const MeetingFormModal = ({ date, meeting, onSubmit, onClose, isEdit }) => {
    const [formData, setFormData] = useState(
      meeting ? {
        id: meeting.id,
        title: meeting.title,
        start: new Date(meeting.start),
        end: new Date(meeting.end),
        participants: meeting.participants.join(', '),
        desc: meeting.desc
      } : {
        title: '',
        start: date ? new Date(date) : new Date(),
        end: date ? new Date(new Date(date).getTime() + 60 * 60 * 1000) : new Date(new Date().getTime() + 60 * 60 * 1000),
        participants: '',
        desc: ''
      }
    );

    const handleSubmit = (e) => {
      e.preventDefault();
      onSubmit({
        ...formData,
        id: meeting ? meeting.id : Date.now(),
        participants: formData.participants.split(',').map(p => p.trim()).filter(p => p)
      });
    };

    return (
      <div className="modal-overlay" onClick={onClose}>
        <div className="modal-detail modern-modal" onClick={e => e.stopPropagation()}>
          <div className="modal-header">
            <h4 className="modal-title">{isEdit ? 'ÏùºÏ†ï ÏàòÏ†ï' : 'ÏÉà ÏùºÏ†ï ÎßåÎì§Í∏∞'}</h4>
            <button className="modal-close-icon" onClick={onClose}>√ó</button>
          </div>
          <form onSubmit={handleSubmit} className="modal-form">
            <div className="form-group">
              <label>Ï†úÎ™©</label>
              <input
                className="modern-input"
                placeholder="ÏùºÏ†ï Ï†úÎ™©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                value={formData.title}
                onChange={e => setFormData({...formData, title: e.target.value})}
                required
              />
            </div>
            <div className="form-row">
              <div className="form-group">
                <label>ÏãúÏûë ÏãúÍ∞Ñ</label>
                <input
                  className="modern-input"
                  type="datetime-local"
                  value={formData.start.toISOString().slice(0, 16)}
                  onChange={e => setFormData({...formData, start: new Date(e.target.value)})}
                  required
                />
              </div>
              <div className="form-group">
                <label>Ï¢ÖÎ£å ÏãúÍ∞Ñ</label>
                <input
                  className="modern-input"
                  type="datetime-local"
                  value={formData.end.toISOString().slice(0, 16)}
                  onChange={e => setFormData({...formData, end: new Date(e.target.value)})}
                  required
                />
              </div>
            </div>
            <div className="form-group">
              <label>Ï∞∏ÏÑùÏûê</label>
              <input
                className="modern-input"
                placeholder="Ï∞∏ÏÑùÏûê Ïù¥Î¶ÑÏùÑ ÏâºÌëúÎ°ú Íµ¨Î∂ÑÌïòÏó¨ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                value={formData.participants}
                onChange={e => setFormData({...formData, participants: e.target.value})}
                required
              />
            </div>
            <div className="form-group">
              <label>ÏÑ§Î™Ö</label>
              <textarea
                className="modern-textarea"
                placeholder="ÏùºÏ†ïÏóê ÎåÄÌïú ÏÑ§Î™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                value={formData.desc}
                onChange={e => setFormData({...formData, desc: e.target.value})}
                required
              />
            </div>
            <div className="modal-actions">
              <button type="submit" className="modern-button">
                {isEdit ? 'ÏàòÏ†ïÌïòÍ∏∞' : 'ÎßåÎì§Í∏∞'}
              </button>
              <button type="button" className="modern-button-secondary" onClick={onClose}>
                Ï∑®ÏÜå
              </button>
            </div>
          </form>
        </div>
      </div>
    );
  };

  const KPICard = ({ title, value, color }) => (
    <div className="kpi-card" style={{ borderLeft: `4px solid ${color}` }}>
      <div className="kpi-title">{title}</div>
      <div className="kpi-value">{value}</div>
    </div>
  );

  const upcomingEvents = events.filter(event => {
    const eventDate = new Date(event.start);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    return eventDate >= today;
  }).sort((a, b) => new Date(a.start) - new Date(b.start));

  // Ï∫òÎ¶∞Îçî Ïù¥Î≤§Ìä∏ ÏÉâÏÉÅ ÏÑ§Ï†ï
  const eventColors = {
    default: {
      backgroundColor: '#EEF2FF',
      borderColor: '#6366F1',
      textColor: '#4F46E5'
    },
    important: {
      backgroundColor: '#FEF2F2',
      borderColor: '#EF4444',
      textColor: '#DC2626'
    },
    casual: {
      backgroundColor: '#F0FDF4',
      borderColor: '#22C55E',
      textColor: '#16A34A'
    }
  };

  return (
    <div className="meeting-manager-container">
      <div className="kpi-dashboard modern-dashboard">
        <KPICard title="ÏöîÏ≤≠Îêú ÎØ∏ÌåÖ" value={events.length} color="#6366F1" />
        <KPICard title="ÏäπÏù∏Îêú ÎØ∏ÌåÖ" value={events.length} color="#22C55E" />
        <KPICard title="Ï∑®ÏÜåÎêú ÎØ∏ÌåÖ" value={0} color="#EF4444" />
        <KPICard title="ÎåÄÍ∏∞Ï§ëÏù∏ ÎØ∏ÌåÖ" value={0} color="#F59E0B" />
      </div>
      <div className="meeting-manager2col">
        <div className="manager-main modern-main">
          <div className="manager-header modern-header">
            <div className="view-selector modern-view-selector">
              <button 
                className={`view-btn modern-view-btn ${calendarView === 'dayGridMonth' ? 'active' : ''}`}
                onClick={() => changeView('month')}
              >
                ÏõîÎ≥Ñ
              </button>
              <button 
                className={`view-btn modern-view-btn ${calendarView === 'timeGridWeek' ? 'active' : ''}`}
                onClick={() => changeView('week')}
              >
                Ï£ºÎ≥Ñ
              </button>
              <button 
                className={`view-btn modern-view-btn ${calendarView === 'timeGridDay' ? 'active' : ''}`}
                onClick={() => changeView('day')}
              >
                ÏùºÎ≥Ñ
              </button>
            </div>
          </div>
          <div className="calendar-container2 modern-calendar">
            <FullCalendar
              ref={calendarRef}
              plugins={[dayGridPlugin, timeGridPlugin, interactionPlugin]}
              initialView={calendarView}
              headerToolbar={{
                left: 'prev',
                center: 'title',
                right: 'next'
              }}
              events={events}
              dateClick={handleDateClick}
              eventClick={handleEventClick}
              height="100%"
              locale="ko"
              allDaySlot={false}
              slotMinTime="06:00:00"
              slotMaxTime="24:00:00"
              nowIndicator={true}
              editable={true}
              slotDuration="00:30:00"
              slotLabelInterval="01:00"
              expandRows={true}
              stickyHeaderDates={true}
              dayMaxEvents={true}
              eventClassNames="modern-event"
              dayCellClassNames="modern-day-cell"
              slotLabelClassNames="modern-slot-label"
              dayHeaderClassNames="modern-day-header"
            />
          </div>
        </div>
        <div className="manager-sidebar">
          <h3>ÏòàÏ†ïÎêú ÎØ∏ÌåÖ</h3>
          <div className="meeting-list">
            {upcomingEvents.map(event => (
              <div key={event.id} className="meeting-item" onClick={() => handleEventClick({ event })}>
                <div className="meeting-color" style={{ backgroundColor: event.backgroundColor }}></div>
                <div className="meeting-info">
                  <div className="meeting-title">{event.title}</div>
                  <div className="meeting-time">
                    {new Date(event.start).toLocaleString('ko-KR', {
                      month: 'short',
                      day: 'numeric',
                      hour: '2-digit',
                      minute: '2-digit'
                    })}
                  </div>
                  <div className="meeting-participants">
                    {event.extendedProps.participants.map((participant, idx) => (
                      <div key={idx} className="participant-avatar">
                        {participant.charAt(0)}
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>
      </div>
      {selectedMeeting && <MeetingDetailModal meeting={selectedMeeting} onClose={() => setSelectedMeeting(null)} />}
      {showCreateDialog && (
        <MeetingFormModal
          date={createDate}
          onSubmit={handleCreateMeeting}
          onClose={() => setShowCreateDialog(false)}
          isEdit={false}
        />
      )}
      {showEditDialog && (
        <MeetingFormModal
          date={createDate}
          meeting={selectedMeeting}
          onSubmit={handleEditMeeting}
          onClose={() => setShowEditDialog(false)}
          isEdit={true}
        />
      )}
    </div>
  );
}

export default MeetingManager;
